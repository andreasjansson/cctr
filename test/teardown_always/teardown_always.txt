%platform unix
===
cleanup any previous marker files
%require
===
rm -f /tmp/cctr_teardown_test_setup_ran /tmp/cctr_teardown_test_teardown_ran /tmp/cctr_teardown_test_main_ran
---

===
run suite with failing setup
%require
===
cctr $CCTR_FIXTURE_DIR/failing_setup --no-color 2>&1 || true
---
F.

⊘ failing_setup: Setup failed (3 tests skipped)

Failures:

✗ failing_setup/_setup: setup that fails
  {{ path }}_setup.txt:1
  Command: touch /tmp/cctr_teardown_test_setup_ran
false


Summary: 0 passed, 0 failed, 3 skipped in {{ t }}s
---
where
* t < 5
* path endswith "failing_setup/"

===
setup marker file exists
===
test -f /tmp/cctr_teardown_test_setup_ran && echo "setup ran"
---
setup ran

===
teardown marker file exists (CRITICAL - teardown must run even when setup fails)
===
test -f /tmp/cctr_teardown_test_teardown_ran && echo "teardown ran"
---
teardown ran

===
main test marker file does NOT exist (main tests skipped when setup fails)
===
test ! -f /tmp/cctr_teardown_test_main_ran && echo "main skipped"
---
main skipped

===
cleanup signal sync markers
%require
===
rm -f /tmp/cctr_signal_sync_*
---

===
SIGINT during test run goes straight to teardown
%require
===
# Start cctr in background using exec so signal reaches cctr directly
(exec cctr $CCTR_FIXTURE_DIR/signal_sync --no-color) &
CCTR_PID=$!

# Poll until test1 signals it has started (max 5 seconds)
for i in $(seq 1 50); do
  if [ -f /tmp/cctr_signal_sync_test1_started ]; then
    break
  fi
  sleep 0.1
done

# Send SIGINT now that test1 is running
kill -INT $CCTR_PID 2>/dev/null

# Wait for cctr to finish
wait $CCTR_PID 2>/dev/null

echo "done"
---
done

===
teardown ran after SIGINT
===
test -f /tmp/cctr_signal_sync_teardown && echo "teardown ran"
---
teardown ran

===
test 1 started but did not finish (was interrupted)
===
if [ -f /tmp/cctr_signal_sync_test1_started ] && [ ! -f /tmp/cctr_signal_sync_test1_finished ]; then
  echo "test1 interrupted correctly"
else
  echo "test1 started=$(test -f /tmp/cctr_signal_sync_test1_started && echo yes || echo no) finished=$(test -f /tmp/cctr_signal_sync_test1_finished && echo yes || echo no)"
fi
---
test1 interrupted correctly

===
tests 2-5 were skipped (did not run)
===
count=0
for f in /tmp/cctr_signal_sync_test2 /tmp/cctr_signal_sync_test3 /tmp/cctr_signal_sync_test4 /tmp/cctr_signal_sync_test5; do
  [ -f "$f" ] && count=$((count + 1))
done
echo "skipped tests that ran: $count"
---
skipped tests that ran: 0
