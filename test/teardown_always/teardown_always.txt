%platform unix
===
cleanup any previous marker files
%require
===
rm -f /tmp/cctr_teardown_test_setup_ran /tmp/cctr_teardown_test_teardown_ran /tmp/cctr_teardown_test_main_ran
---

===
run suite with failing setup
%require
===
cctr $CCTR_FIXTURE_DIR/failing_setup --no-color 2>&1 || true
---
F.

âŠ˜ failing_setup: Setup failed (3 tests skipped)

Failures:

âœ— failing_setup/_setup: setup that fails
  {{ path }}_setup.txt:1
  Command: touch /tmp/cctr_teardown_test_setup_ran
false


Summary: 0 passed, 0 failed, 3 skipped in {{ t }}s
---
where
* t < 5
* path endswith "failing_setup/"

===
setup marker file exists
===
test -f /tmp/cctr_teardown_test_setup_ran && echo "setup ran"
---
setup ran

===
teardown marker file exists (CRITICAL - teardown must run even when setup fails)
===
test -f /tmp/cctr_teardown_test_teardown_ran && echo "teardown ran"
---
teardown ran

===
main test marker file does NOT exist (main tests skipped when setup fails)
===
test ! -f /tmp/cctr_teardown_test_main_ran && echo "main skipped"
---
main skipped

===
cleanup signal test markers
%require
===
rm -f /tmp/cctr_signal_test_*
---

===
teardown runs even when interrupted by SIGTERM
===
# Start cctr in background running slow tests
cctr $CCTR_FIXTURE_DIR/slow_tests --no-color 2>&1 &
CCTR_PID=$!
# Wait long enough for setup AND first test to start
sleep 0.7
# Send SIGTERM
kill -TERM $CCTR_PID 2>/dev/null || true
# Wait for cctr to finish
wait $CCTR_PID 2>/dev/null || true
# Check that teardown ran
test -f /tmp/cctr_signal_test_teardown_ran && echo "teardown ran after SIGTERM"
---
teardown ran after SIGTERM

===
not all slow tests completed when interrupted
===
# Count how many test markers exist (should be fewer than 5)
count=$(ls /tmp/cctr_signal_test_test*_ran 2>/dev/null | wc -l | tr -d ' ')
if [ "$count" -lt 5 ]; then echo "interrupted early: $count tests ran"; else echo "all 5 tests ran"; fi
---
interrupted early: {{ n }} tests ran
---
where
* n < 5
