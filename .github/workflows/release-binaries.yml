name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # Build and upload binaries for all platforms
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
          # Linux ARM64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
          # macOS x86_64
          - target: x86_64-apple-darwin
            os: macos-latest
          # macOS ARM64 (Apple Silicon)
          - target: aarch64-apple-darwin
            os: macos-latest
          # Windows x86_64
          - target: x86_64-pc-windows-msvc
            os: windows-latest
          # Windows ARM64
          - target: aarch64-pc-windows-msvc
            os: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: taiki-e/upload-rust-binary-action@v1
        with:
          bin: cctr
          target: ${{ matrix.target }}
          archive: cctr-$tag-$target
          token: ${{ secrets.GITHUB_TOKEN }}

  # Publish to crates.io
  publish:
    name: Publish to crates.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Publish workspace to crates.io
        run: cargo publish --workspace --no-verify
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # Create GitHub Release with changelog
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, publish]
    steps:
      - uses: actions/checkout@v4
      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      - name: Create Release Notes
        run: |
          echo "## What's Changed" > release_notes.md
          echo "" >> release_notes.md
          echo "See the [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/crates/cctr/CHANGELOG.md) for details." >> release_notes.md
          echo "" >> release_notes.md
          echo "## Installation" >> release_notes.md
          echo "" >> release_notes.md
          echo '```bash' >> release_notes.md
          echo "# Via cargo" >> release_notes.md
          echo "cargo install cctr" >> release_notes.md
          echo "" >> release_notes.md
          echo "# Via Homebrew (macOS/Linux)" >> release_notes.md
          echo "brew install andreasjansson/tap/cctr" >> release_notes.md
          echo '```' >> release_notes.md
      - name: Update Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release edit "v${{ steps.version.outputs.version }}" \
            --notes-file release_notes.md \
            --latest
